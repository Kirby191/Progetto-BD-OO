CREATE OR REPLACE FUNCTION Storico_Giocatori_Squadra(Squadra SQUADRA.Nome_Squadra%TYPE)
RETURNS TABLE(SSN_Giocatore GIOCATORE.SSN%TYPE)
AS $$
	DECLARE
	-- Per convenzione gli ID_Militanza sono un autoincrement che continua ad incrementare
	-- più militanze inseriamo. Di conseguenza, una Militanza sarà più "recente" di un'altra in base al suo valore
	Cursor Militanze IS(
	SELECT ID_Militanza
	FROM Riferisce
	WHERE NomeSquadra = Squadra
	ORDER BY ID_Militanza ASC);
	
	Curr_Militanza MILITANZA.ID_Militanza%TYPE;
	final_string TEXT;
	
		BEGIN
			OPEN Militanze;
	
			LOOP
	
				FETCH Militanze INTO Curr_Militanza;		
				EXIT WHEN Militanze%NotFound;
			
				SELECT DISTINCT SSN INTO Curr_SSN
				FROM Militanza
				WHERE ID_Militanza = Curr_Militanza;
				
				final_string := final_string || Curr_SSN || ' ';
				
			END LOOP;
			
			CLOSE Militanze;
			
			RETURN QUERY SELECT * FROM string_to_table(final_string, ' ');
			
		END;
$$ Language plpgsql
